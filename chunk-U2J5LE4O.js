import{a as k}from"./chunk-6XQ75H35.js";import{c as d,e as g,j as R}from"./chunk-DMW3Z3DJ.js";import{Jb as u,L as p,M as l,P as h,V as s,n as i,na as c,q as o,x as a,z as n}from"./chunk-NEUCA32X.js";var v=class r{http=s(g);router=s(R);apiUrl=`${k.externalAuth.apiUrl}/auth/`;httpHeaders=new d({"Content-Type":"application/json",Accept:"application/json","Allow-Origin":"*","Access-Control-Allow-Origin":"*"});_token=c(localStorage.getItem("token"));isAuthenticated=u(()=>!!this.getToken()&&!this.isTokenExpired(this.getToken()));tokenCheckSubscription;constructor(){this.setupTokenValidation()}login(e){return this.http.post(`${this.apiUrl}`,e,{headers:this.httpHeaders}).pipe(o(t=>this.handleAuthResponse(t)),n(t=>i(()=>new Error(t.message||"An error occurred during login."))))}register(e){return this.http.post(`${this.apiUrl}/Register`,e,{headers:this.httpHeaders}).pipe(o(t=>this.handleRegisterResponse(t)),n(t=>i(()=>new Error(t))))}handleRegistrationTokenValidation(e){debugger;if(!e.isValid)throw new Error(e.errors.length>0?e.errors[0].description:"Token validation failed");return e}handleRegisterResponse(e){if(!e.succeeded)throw new Error(e.errors.length>0?e.errors[0].description:"Registration failed");return e}handleAuthResponse(e){if(!e.success||!e.token)throw new Error(e.errors||"Login failed");return localStorage.setItem("token",e.token),this._token.set(e.token),e}isTokenExpired(e){if(!e)return!0;try{let m=JSON.parse(atob(e.split(".")[1])).exp*1e3;return Date.now()>=m}catch(t){return console.error("Token validation error:",t),!0}}setupTokenValidation(){this.tokenCheckSubscription?.unsubscribe(),this.tokenCheckSubscription=a(12e5).pipe(l(()=>console.log("Checking token validity...")),p(()=>!!this.getToken())).subscribe(()=>{this.validateToken()})}validateToken(){let e=this.getToken();return!e||this.isTokenExpired(e)?(this.logout(),!1):!0}logout(){localStorage.removeItem("token"),this._token.set(null),this.tokenCheckSubscription?.unsubscribe(),this.router.navigate(["/login"])}isAuthenticatedValue(){return this.isAuthenticated()}getToken(){return this._token()}static \u0275fac=function(t){return new(t||r)};static \u0275prov=h({token:r,factory:r.\u0275fac,providedIn:"root"})};export{v as a};
